<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#121212" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Potok — Home</title>
  
  <!-- Telegram Web App SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-NBWRD903C5"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-NBWRD903C5', {
      enhanced_measurement: true
    });

    // Функция для отправки данных пользователя в Google Sheets
    async function sendUserDataToGoogleSheets(user) {
      try {
        const userData = {
          first_name: user.first_name || '',
          last_name: user.last_name || '',
          username: user.username || '',
          date_time: new Date().toISOString()
        };

        console.log('Отправляем данные:', userData);

        const response = await fetch('https://script.google.com/macros/s/AKfycbwe5w0CzmIKkFS77H3WFVDqTjhrhZD47VN1YeJW4ql_JcapHv-SzoD2uVoZVPxaoIer/exec', {
          method: 'POST',
          mode: 'no-cors',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(userData)
        });

        console.log('✅ Данные пользователя отправлены в Google Sheets');
      } catch (error) {
        console.error('❌ Ошибка при отправке данных в Google Sheets:', error);
      }
    }

    // Функция для обновления хедера с данными пользователя
    function updateUserHeader(user) {
      const logo = document.querySelector('.logo');
      if (logo && user) {
        const firstName = user.first_name || '';
        const lastName = user.last_name || '';
        const fullName = `${firstName} ${lastName}`.trim() || 'Пользователь';
        
        // Создаем аватар (первая буква имени, если нет фото)
        const avatarLetter = firstName ? firstName.charAt(0).toUpperCase() : 'П';
        
        logo.innerHTML = `
          <div class="user-header">
            <div class="user-avatar">
              ${user.photo_url ? 
                `<img src="${user.photo_url}" alt="${fullName}" class="avatar-image">` : 
                `<div class="avatar-placeholder">${avatarLetter}</div>`
              }
            </div>
            <div class="user-name">${fullName}</div>
          </div>
        `;
      }
    }

    // Инициализация после загрузки DOM
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Инициализация приложения...');
      
      // Проверяем наличие Telegram Web App
      if (window.Telegram?.WebApp) {
        console.log('✅ Telegram Web App обнаружен!');
        
        // Инициализация Telegram Web App
        window.Telegram.WebApp.ready();
        window.Telegram.WebApp.expand();
        
        // Получаем данные пользователя из Telegram
        const tgUser = window.Telegram.WebApp.initDataUnsafe?.user;
        
        if (tgUser) {
          console.log('✅ Пользователь получен:', tgUser);
          
          // Отправляем данные пользователя в Google Analytics
          gtag('set', {
            'user_id': tgUser.id,
            'custom_map': {
              'telegram_username': tgUser.username || 'unknown',
              'telegram_first_name': tgUser.first_name || 'unknown'
            }
          });
          
          // Отправляем данные пользователя в Google Sheets
          sendUserDataToGoogleSheets(tgUser);
          
          // Обновляем хедер с данными пользователя
          updateUserHeader(tgUser);
          
          // Отправляем событие о запуске мини-приложения
          gtag('event', 'mini_app_start', {
            event_category: 'telegram',
            event_label: 'app_launched'
          });
        } else {
          console.log('❌ Данные пользователя не получены');
        }
        
        // Настраиваем кнопки Telegram
        window.Telegram.WebApp.MainButton.hide();
        window.Telegram.WebApp.BackButton.hide();
        
        // Включаем обратную связь при нажатиях
        window.Telegram.WebApp.enableClosingConfirmation();
      } else {
        console.log('⚠️ Telegram Web App НЕ обнаружен - используем тестовые данные');
        
        // Для тестирования добавляем фейковые данные
        const testUser = {
          id: 12345,
          first_name: "Анна",
          last_name: "Иванова",
          username: "anna_test"
        };
        
        updateUserHeader(testUser);
      }

      // Проверяем что gtag работает
      if (typeof gtag !== 'undefined') {
        console.log('✅ Google Analytics работает!');
        gtag('event', 'test_load', {
          event_category: 'test',
          event_label: 'page_loaded'
        });
      } else {
        console.log('❌ Google Analytics НЕ работает!');
      }

      // Отслеживание кликов по кнопкам
      const practiceButton = document.querySelector('.preview-container');
      if (practiceButton) {
        practiceButton.addEventListener('click', function() {
          console.log('Клик по кнопке "Практика дня"');
          // Тактильная обратная связь в Telegram
          if (window.Telegram?.WebApp?.HapticFeedback) {
            window.Telegram.WebApp.HapticFeedback.impactOccurred('medium');
          }
          gtag('event', 'click', {
            event_category: 'button',
            event_label: 'Практика дня'
          });
        });
      }

      // Отслеживание кликов по карточкам
      const cards = document.querySelectorAll('.card');
      cards.forEach(function(card) {
        card.addEventListener('click', function() {
          const cardTitle = card.querySelector('.card-title')?.textContent || 'Unknown';
          console.log('Клик по карточке:', cardTitle);
          // Тактильная обратная связь в Telegram
          if (window.Telegram?.WebApp?.HapticFeedback) {
            window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
          }
          gtag('event', 'card_click', {
            event_category: 'card',
            event_label: cardTitle
          });
        });
      });

      // Отслеживание навигации
      const tabs = document.querySelectorAll('.tab');
      tabs.forEach(function(tab) {
        tab.addEventListener('click', function() {
          const tabName = tab.querySelector('div')?.textContent || 'Unknown';
          console.log('Клик по табу:', tabName);
          // Тактильная обратная связь в Telegram
          if (window.Telegram?.WebApp?.HapticFeedback) {
            window.Telegram.WebApp.HapticFeedback.selectionChanged();
          }
          gtag('event', 'navigation', {
            event_category: 'tab_bar',
            event_label: tabName
          });
        });
      });

      // Отслеживание клика по кнопке связи
      const contactButton = document.querySelector('.contact-button');
      if (contactButton) {
        contactButton.addEventListener('click', function() {
          console.log('Клик по кнопке "Telegram"');
          // Тактильная обратная связь в Telegram
          if (window.Telegram?.WebApp?.HapticFeedback) {
            window.Telegram.WebApp.HapticFeedback.impactOccurred('medium');
          }
          gtag('event', 'contact_click', {
            event_category: 'contact',
            event_label: 'telegram_button'
          });
        });
      }
    });
  </script>

  <style>
    :root {
      --main: #121212;
      --white: #ffffff;
      --text-2: #b3b3b3;
      --green: #34A853;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background-color: var(--main);
      font-family: "Inter", sans-serif;
    }

    a {
      text-decoration: none;
      color: inherit;
    }

    .home {
      max-width: 375px;
      margin: 0 auto;
      padding: 120px 24px 24px 24px;
      display: flex;
      flex-direction: column;
      padding-bottom: 96px;
      box-sizing: border-box;
    }

    .section-spacing {
      margin-bottom: 48px;
    }

    .logo {
      position: fixed;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      max-width: 375px;
      width: 100%;
      z-index: 100;
      display: block;
      background-color: var(--main);
      padding: 24px 24px 24px 24px;
      box-sizing: border-box;
    }

    .logo img {
      height: 33px;
      width: auto;
      display: block;
    }

    .user-header {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .user-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      overflow: hidden;
      flex-shrink: 0;
    }

    .avatar-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center;
    }

    .avatar-placeholder {
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.05);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: 600;
      color: var(--text-2);
    }

    .user-name {
      font-size: 18px;
      line-height: 24px;
      font-weight: 500;
      color: var(--white);
    }

    .header {
      max-width: 327px;
      width: 100%;
      margin: 0 auto 48px auto;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .text-welcome {
      font-size: 14px;
      line-height: 20px;
      font-weight: 400;
      color: var(--text-2);
    }

    .text-title {
      font-size: 24px;
      line-height: 32px;
      font-weight: 600;
      color: var(--white);
    }

    .preview-container {
      width: 327px;
      height: 120px;
      background-color: var(--green);
      border-radius: 8px;
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.2s;
      user-select: none;
      -webkit-user-select: none;
      touch-action: manipulation;
    }

    .preview-container:active {
      transform: scale(0.98);
    }

    .preview-animation {
      width: 100%;
      height: 100%;
      pointer-events: none;
    }

    .arrow {
      width: 5px;
      height: 10px;
    }

    .cards {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .card {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background-color: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      width: 100%;
      max-width: 327px;
      height: 80px;
      margin: 0 auto;
      box-sizing: border-box;
      padding-right: 16px;
      transition: background-color 0.2s;
    }

    .card:active {
      background-color: rgba(255, 255, 255, 0.1);
    }

    .card img:first-child {
      width: 118px;
      height: 80px;
      object-fit: cover;
      border-radius: 8px 0 0 8px;
      flex-shrink: 0;
    }

    .card-content {
      display: flex;
      flex-direction: column;
      justify-content: center;
      flex: 1;
      margin-left: 16px;
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      line-height: 24px;
      color: var(--white);
    }

    .card-subtitle {
      font-size: 12px;
      color: var(--text-2);
      line-height: 16px;
    }

    .card .arrow {
      width: 5px;
      height: 10px;
      margin-left: 16px;
    }

    .tab-bar {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 375px;
      background-color: var(--main);
      border-top: 1px solid rgba(255, 255, 255, 0.15);
      display: flex;
      justify-content: space-around;
      padding: 12px 0;
    }

    .tab {
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 12px;
      line-height: 18px;
      font-weight: 400;
      color: var(--text-2);
      gap: 8px;
    }

    .tab.active {
      font-weight: 600;
      color: var(--green);
    }

    .tab.active img {
      filter: brightness(1.5);
    }

    .tab img {
      width: 24px;
      height: 24px;
      transition: transform 0.1s, filter 0.1s;
    }

    .tab img:active {
      transform: scale(0.9);
      filter: brightness(1.5);
    }
  </style>
</head>
<body>
  <div class="home">
    <!-- Логотип будет заменен на аватар и имя пользователя через JavaScript -->
    <div class="logo">
      <img src="img/logo.svg" alt="Potok logo">
    </div>

    <div class="header">
      <div class="text-welcome">Добро пожаловать!</div>
      <div class="text-title">С чего хочешь начать?</div>
    </div>

    <div class="preview-container section-spacing" onclick="window.location.href='ponda.html';">
      <svg class="preview-animation" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 327 120">
        <!-- Background -->
        <rect width="327" height="120" fill="#34A853" rx="8" />
        
        <!-- Random white dots -->
        <circle cx="60" cy="25" r="1.5" fill="white" opacity="0.7">
          <animate attributeName="opacity" values="0.7;0.3;0.7" dur="2.5s" repeatCount="indefinite"/>
        </circle>
        <circle cx="270" cy="30" r="2" fill="white" opacity="0.5">
          <animate attributeName="opacity" values="0.5;0.8;0.5" dur="3s" repeatCount="indefinite"/>
        </circle>
        <circle cx="250" cy="90" r="1" fill="white" opacity="0.6">
          <animate attributeName="opacity" values="0.6;0.2;0.6" dur="2s" repeatCount="indefinite"/>
        </circle>
        <circle cx="80" cy="85" r="1.8" fill="white" opacity="0.4">
          <animate attributeName="opacity" values="0.4;0.7;0.4" dur="3.5s" repeatCount="indefinite"/>
        </circle>
        <circle cx="180" cy="20" r="1.2" fill="white" opacity="0.8">
          <animate attributeName="opacity" values="0.8;0.4;0.8" dur="2.2s" repeatCount="indefinite"/>
        </circle>
        <circle cx="300" cy="70" r="1.4" fill="white" opacity="0.6">
          <animate attributeName="opacity" values="0.6;0.9;0.6" dur="2.8s" repeatCount="indefinite"/>
        </circle>
        <circle cx="40" cy="60" r="2.2" fill="white" opacity="0.3">
          <animate attributeName="opacity" values="0.3;0.6;0.3" dur="3.2s" repeatCount="indefinite"/>
        </circle>
        <circle cx="200" cy="100" r="1.6" fill="white" opacity="0.7">
          <animate attributeName="opacity" values="0.7;0.2;0.7" dur="2.4s" repeatCount="indefinite"/>
        </circle>
        
        <!-- 5 концентрических волн -->
        <!-- Wave 1 -->
        <circle cx="163.5" cy="60" r="45" fill="rgba(220, 255, 220, 0.5)" opacity="0">
          <animate 
            attributeName="r" 
            values="45;10" 
            dur="8s" 
            repeatCount="indefinite"
            begin="0s"
          />
          <animate 
            attributeName="opacity" 
            values="0;0.5;0.9" 
            dur="8s" 
            repeatCount="indefinite"
            begin="0s"
          />
        </circle>
        
        <!-- Wave 2 -->
        <circle cx="163.5" cy="60" r="45" fill="rgba(220, 255, 220, 0.5)" opacity="0">
          <animate 
            attributeName="r" 
            values="45;10" 
            dur="8s" 
            repeatCount="indefinite"
            begin="1.6s"
          />
          <animate 
            attributeName="opacity" 
            values="0;0.5;0.9" 
            dur="8s" 
            repeatCount="indefinite"
            begin="1.6s"
          />
        </circle>
        
        <!-- Wave 3 -->
        <circle cx="163.5" cy="60" r="45" fill="rgba(220, 255, 220, 0.5)" opacity="0">
          <animate 
            attributeName="r" 
            values="45;10" 
            dur="8s" 
            repeatCount="indefinite"
            begin="3.2s"
          />
          <animate 
            attributeName="opacity" 
            values="0;0.5;0.9" 
            dur="8s" 
            repeatCount="indefinite"
            begin="3.2s"
          />
        </circle>
        
        <!-- Wave 4 -->
        <circle cx="163.5" cy="60" r="45" fill="rgba(220, 255, 220, 0.5)" opacity="0">
          <animate 
            attributeName="r" 
            values="45;10" 
            dur="8s" 
            repeatCount="indefinite"
            begin="4.8s"
          />
          <animate 
            attributeName="opacity" 
            values="0;0.5;0.9" 
            dur="8s" 
            repeatCount="indefinite"
            begin="4.8s"
          />
        </circle>
        
        <!-- Wave 5 -->
        <circle cx="163.5" cy="60" r="45" fill="rgba(220, 255, 220, 0.5)" opacity="0">
          <animate 
            attributeName="r" 
            values="45;10" 
            dur="8s" 
            repeatCount="indefinite"
            begin="6.4s"
          />
          <animate 
            attributeName="opacity" 
            values="0;0.5;0.9" 
            dur="8s" 
            repeatCount="indefinite"
            begin="6.4s"
          />
        </circle>
        
        <!-- Play button overlay -->
        <g transform="translate(163.5, 60)">
          <!-- Button background -->
          <circle r="24" fill="rgba(255, 255, 255, 0.03)" stroke="rgba(255, 255, 255, 0.1)" stroke-width="1"/>
          <!-- Play icon -->
          <path d="M-6 -8 L-6 8 L8 0 Z" fill="white" opacity="0.9"/>
        </g>
      </svg>
    </div>

    <div class="cards">
      <a href="pond.html" class="card">
        <img src="img/mind.jpg" alt="Успокоить мысли">
        <div class="card-content">
          <div class="card-title">Успокоить мысли</div>
          <div class="card-subtitle">Медитация</div>
        </div>
        <img class="arrow" src="img/arrow.svg" alt="arrow">
      </a>
      <a href="478.html" class="card">
        <img src="img/breathing.jpg" alt="Снизить стресс">
        <div class="card-content">
          <div class="card-title">Снизить стресс</div>
          <div class="card-subtitle">Дыхание</div>
        </div>
        <img class="arrow" src="img/arrow.svg" alt="arrow">
      </a>
      <a href="stars.html" class="card">
        <img src="img/sleep.jpg" alt="Улучшить сон">
        <div class="card-content">
          <div class="card-title">Улучшить сон</div>
          <div class="card-subtitle">Сон</div>
        </div>
        <img class="arrow" src="img/arrow.svg" alt="arrow">
      </a>
    </div>
  </div>

  <footer class="tab-bar">
    <a href="index.html" class="tab active">
      <img src="img/home-active.svg" alt="Сегодня">
      <div>Сегодня</div>
    </a>
    <a href="practices.html" class="tab">
      <img src="img/practices.svg" alt="Практики">
      <div>Практики</div>
    </a>
    <a href="journal.html" class="tab">
      <img src="img/journal.svg" alt="Журнал">
      <div>Журнал</div>
    </a>
  </footer>
</body>
</html>